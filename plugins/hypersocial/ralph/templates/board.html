<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ralph Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .kanban-column {
      min-height: 500px;
      max-height: calc(100vh - 300px);
      overflow-y: auto;
    }
    .story-card {
      transition: all 0.2s;
    }
    .story-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    @keyframes pulse-green {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .active-indicator {
      animation: pulse-green 2s infinite;
    }
    .activity-feed {
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-[1800px] mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold text-gray-900">
          Ralph Dashboard
          <span id="feature-name" class="text-blue-600"></span>
        </h1>
        <div class="flex items-center gap-4">
          <div class="text-sm text-gray-500">
            Auto-refresh: <span class="font-semibold" id="refresh-countdown">5</span>s
          </div>
          <button onclick="loadData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
            Refresh Now
          </button>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-700">Overall Progress</span>
          <span id="progress-text" class="text-sm font-semibold text-gray-900">0/0 stories (0%)</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-4 gap-4 text-center">
        <div class="bg-yellow-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-yellow-600" id="stat-pending">0</div>
          <div class="text-xs text-gray-600">Pending</div>
        </div>
        <div class="bg-blue-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-blue-600" id="stat-active">0</div>
          <div class="text-xs text-gray-600">In Progress</div>
        </div>
        <div class="bg-green-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-green-600" id="stat-complete">0</div>
          <div class="text-xs text-gray-600">Completed</div>
        </div>
        <div class="bg-red-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-red-600" id="stat-blocked">0</div>
          <div class="text-xs text-gray-600">Blocked</div>
        </div>
      </div>
    </div>

    <!-- Main Content: Kanban + Activity Feed -->
    <div class="grid grid-cols-3 gap-6">
      <!-- Left: Kanban Board (2 columns) -->
      <div class="col-span-2">
        <div class="grid grid-cols-4 gap-4">
          <!-- Pending Column -->
          <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>
              Pending
            </h2>
            <div id="column-pending" class="kanban-column space-y-3"></div>
          </div>

          <!-- In Progress Column -->
          <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="w-3 h-3 bg-blue-500 rounded-full mr-2 active-indicator"></span>
              In Progress
            </h2>
            <div id="column-in_progress" class="kanban-column space-y-3"></div>
          </div>

          <!-- Completed Column -->
          <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
              Completed
            </h2>
            <div id="column-completed" class="kanban-column space-y-3"></div>
          </div>

          <!-- Blocked Column -->
          <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
              Blocked
            </h2>
            <div id="column-blocked" class="kanban-column space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- Right: Activity Feed (1 column) -->
      <div class="col-span-1">
        <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Progress Log</h2>
          <div id="recent-activity" class="activity-feed space-y-3">
            <div class="text-sm text-gray-500">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let refreshInterval;
    let countdownInterval;
    let countdown = 5;

    // Get feature name from path
    const featureName = window.location.pathname.split('/.ralph/')[1]?.split('/')[0] || 'unknown';
    document.getElementById('feature-name').textContent = featureName;
    document.title = `Ralph Dashboard - ${featureName}`;

    // Load data
    async function loadData() {
      try {
        // Fetch prd.json
        const prdResponse = await fetch('../prd.json');
        const prd = await prdResponse.json();

        // Fetch progress.txt
        const progressResponse = await fetch('../progress.txt');
        const progressText = await progressResponse.text();

        // Render dashboard
        renderDashboard(prd, progressText);

        // Reset countdown
        countdown = 5;
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function renderDashboard(prd, progressText) {
      const stories = prd.stories || [];

      // Calculate stats
      const stats = {
        pending: stories.filter(s => s.status === 'not_started').length,
        active: stories.filter(s => s.status === 'in_progress').length,
        complete: stories.filter(s => s.status === 'completed').length,
        blocked: stories.filter(s => s.status === 'blocked').length,
      };

      // Update stats
      document.getElementById('stat-pending').textContent = stats.pending;
      document.getElementById('stat-active').textContent = stats.active;
      document.getElementById('stat-complete').textContent = stats.complete;
      document.getElementById('stat-blocked').textContent = stats.blocked;

      // Update progress bar
      const total = stories.length;
      const completed = stats.complete;
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progress-bar').style.width = percentage + '%';
      document.getElementById('progress-text').textContent = `${completed}/${total} stories (${percentage}%)`;

      // Clear columns
      document.getElementById('column-pending').innerHTML = '';
      document.getElementById('column-in_progress').innerHTML = '';
      document.getElementById('column-completed').innerHTML = '';
      document.getElementById('column-blocked').innerHTML = '';

      // Render story cards
      stories.forEach(story => {
        const card = createStoryCard(story);
        const column = getColumnForStatus(story.status);
        document.getElementById(`column-${column}`).appendChild(card);
      });

      // Render recent activity
      renderRecentActivity(progressText);
    }

    function getColumnForStatus(status) {
      const map = {
        'not_started': 'pending',
        'in_progress': 'in_progress',
        'completed': 'completed',
        'blocked': 'blocked',
      };
      return map[status] || 'pending';
    }

    function createStoryCard(story) {
      const card = document.createElement('div');
      card.className = 'story-card bg-white border-2 rounded-lg p-4 cursor-pointer';

      // Border color based on status
      const borderColors = {
        'not_started': 'border-gray-200',
        'in_progress': 'border-blue-400',
        'completed': 'border-green-400',
        'blocked': 'border-red-400',
      };
      card.className += ' ' + borderColors[story.status];

      // Story ID badge
      const statusColors = {
        'not_started': 'bg-yellow-100 text-yellow-700',
        'in_progress': 'bg-blue-100 text-blue-700',
        'completed': 'bg-green-100 text-green-700',
        'blocked': 'bg-red-100 text-red-700',
      };

      card.innerHTML = `
        <div class="flex items-start justify-between mb-2">
          <span class="text-xs font-mono font-semibold ${statusColors[story.status]} px-2 py-1 rounded">
            ${story.id}
          </span>
          <span class="text-xs text-gray-500">
            P${story.priority}
          </span>
        </div>
        <h3 class="font-medium text-gray-900 text-sm mb-2 line-clamp-2">
          ${story.title}
        </h3>
        <div class="text-xs text-gray-500 space-y-1">
          ${story.dependencies && story.dependencies.length > 0 ? `
            <div class="flex items-center gap-1">
              <span>üîó</span>
              <span>${story.dependencies.length} dep(s)</span>
            </div>
          ` : ''}
          ${story.blockers && story.blockers.length > 0 ? `
            <div class="text-red-600 font-medium">
              ‚ö†Ô∏è ${story.blockers[0]}
            </div>
          ` : ''}
        </div>
      `;

      // Click to show details
      card.onclick = () => showStoryDetails(story);

      return card;
    }

    function showStoryDetails(story) {
      alert(`Story: ${story.id}

Title: ${story.title}

Steps:
${story.steps.map((s, i) => `${i + 1}. ${s}`).join('\n')}

Passes:
${story.passes.map((p, i) => `${i + 1}. ${p}`).join('\n')}

Dependencies: ${story.dependencies.length > 0 ? story.dependencies.join(', ') : 'None'}
Priority: ${story.priority}
Status: ${story.status}
${story.blockers && story.blockers.length > 0 ? `\nBlockers:\n${story.blockers.join('\n')}` : ''}`);
    }

    function renderRecentActivity(progressText) {
      const activityDiv = document.getElementById('recent-activity');
      const lines = progressText.split('\n').filter(l => l.trim());

      // Parse recent entries (already in reverse chronological order)
      const activities = [];
      let currentEntry = null;

      for (const line of lines) {
        if (line.match(/^(COMPLETED|STARTED|ERROR):/)) {
          if (currentEntry) activities.push(currentEntry);
          const match = line.match(/^(COMPLETED|STARTED|ERROR): (.+)/);
          currentEntry = {
            type: match[1],
            text: match[2],
            details: []
          };
        } else if (currentEntry && line.trim()) {
          currentEntry.details.push(line.trim());
        }
      }
      if (currentEntry) activities.push(currentEntry);

      // Render all activities
      activityDiv.innerHTML = activities.map(a => {
        const icons = {
          'COMPLETED': '‚úÖ',
          'STARTED': '‚ñ∂Ô∏è',
          'ERROR': '‚ùå'
        };
        const colors = {
          'COMPLETED': 'text-green-700',
          'STARTED': 'text-blue-700',
          'ERROR': 'text-red-700'
        };
        const bgColors = {
          'COMPLETED': 'bg-green-50',
          'STARTED': 'bg-blue-50',
          'ERROR': 'bg-red-50'
        };

        return `
          <div class="${bgColors[a.type]} rounded-lg p-3 border border-gray-200">
            <div class="flex items-start gap-2 text-sm">
              <span class="text-xl">${icons[a.type]}</span>
              <div class="flex-1 min-w-0">
                <div class="${colors[a.type]} font-semibold mb-1">${a.text}</div>
                ${a.details.map(d => `<div class="text-gray-600 text-xs leading-relaxed truncate" title="${d}">${d}</div>`).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('') || '<div class="text-sm text-gray-500 p-4 text-center">No activity yet</div>';
    }

    // Countdown display
    function updateCountdown() {
      document.getElementById('refresh-countdown').textContent = countdown;
      countdown--;
      if (countdown < 0) {
        countdown = 5;
        loadData();
      }
    }

    // Initial load
    loadData();

    // Auto-refresh every 5 seconds
    countdownInterval = setInterval(updateCountdown, 1000);
  </script>
</body>
</html>
