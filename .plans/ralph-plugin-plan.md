# Ralph Plugin Plan

## Overview

Build a Claude Code plugin for autonomous feature development with story-based tracking, review gates, and crash recovery.

**Location:** `hypersocialinc/claude-plugins` repo, under `plugins/hypersocial/ralph/` (or as separate plugin)

---

## Plugin Structure

```
ralph/
├── .claude-plugin/
│   └── plugin.json
├── commands/
│   ├── ralph-new.md
│   ├── ralph-continue.md
│   ├── ralph-status.md
│   ├── ralph-done.md
│   └── ralph-abandon.md
├── agents/
│   ├── ralph-planner.md
│   └── ralph-executor.md
├── skills/
│   └── ralph/
│       └── SKILL.md
├── hooks/
│   └── hooks.json
└── templates/
    ├── claude.md
    ├── prd.json
    ├── plan.md
    └── progress.txt
```

---

## In-Repo Structure (created by Ralph)

```
project/
├── .ralph/
│   └── <feature-name>/
│       ├── claude.md        # Workflow instructions
│       ├── plan.md          # Feature spec
│       ├── prd.json         # Stories with status
│       └── progress.txt     # Work log + patterns
├── .ralph-archive/          # Completed features
│   └── <feature-name>/
│       └── ...
└── CLAUDE.md                # Updated with permanent learnings
```

---

## Commands

### 1. `/ralph-new <feature-name> [--from <file>]`

**Purpose:** Start a new feature

**Arguments:**
- `<feature-name>` - Name of the feature (e.g., `auth-system`)
- `--from <file>` - Optional: path to existing spec/design doc to use instead of Q&A

**Flow:**
1. Check if `.ralph/` has an active feature
   - If yes → ask: "Active feature exists. Abandon it, complete it, or cancel?"
2. Create git branch `ralph/<feature-name>`
3. Create `.ralph/<feature-name>/` directory
4. Copy templates (including `.ralph/ralph.sh` bash script)
5. Launch `ralph-planner` agent:
   - If `--from` provided: read that file as spec
   - Otherwise: ask 3-5 questions about the feature
   - Generate `plan.md`
   - Break into stories in `prd.json` (aim for 15-45 min each, max ~15 stories)
6. Initialize `progress.txt` with Codebase Patterns section
7. Commit: `"ralph: init <feature-name>"`
8. Output: "Ready. Run `/ralph-run` for autonomous mode or `/ralph-next` for step-by-step."

---

### 2. `/ralph-run [iterations]`

**Purpose:** Start autonomous loop (executes multiple stories until done/blocked)

**Flow:**
1. Find active feature in `.ralph/`
   - If none → error: "No active ralph. Run `/ralph-new`"
2. Generate `.ralph/ralph.sh` bash script if not exists
3. Execute options (user choice or auto):
   - **Option A (background):** `bash .ralph/ralph.sh 20 > .ralph/output.log 2>&1 &`
   - **Option B (manual):** User opens terminal and runs it themselves
4. Output message:
   ```
   Ralph will run autonomously with full permissions.
   Running 20 iterations max (or until complete/blocked).
   Output: .ralph/output.log

   To watch live: tail -f .ralph/output.log
   To check status: /ralph-status
   Cancel anytime: Ctrl+C in terminal
   ```

**Bash Script (`.ralph/ralph.sh`):**
```bash
#!/bin/bash
# Generated by /ralph-run

MAX_ITERATIONS=${1:-20}
SCRIPT_DIR="$(dirname "$0")"

for i in $(seq 1 $MAX_ITERATIONS); do
  echo "=== Ralph iteration $i/$MAX_ITERATIONS ==="

  OUTPUT=$(claude --dangerously-skip-permissions \
    -p "$(cat "$SCRIPT_DIR"/claude.md)" 2>&1)

  if echo "$OUTPUT" | grep -q "RALPH_COMPLETE"; then
    echo "✅ All stories complete!"
    exit 0
  fi

  if echo "$OUTPUT" | grep -q "RALPH_BLOCKED"; then
    echo "⚠️ Blocked - needs human input"
    exit 1
  fi

  sleep 2
done

echo "⚠️ Max iterations reached"
exit 1
```

**Each iteration:**
1. Fresh Claude context (no context growth)
2. Read files (progress.txt, prd.json, claude.md)
3. Check for incomplete story (crash recovery)
4. Pick next story
5. Execute story cycle (implement → verify → review → commit)
6. Update tracking files
7. Exit with signal: continue / RALPH_COMPLETE / RALPH_BLOCKED

---

### 3. `/ralph-next`

**Purpose:** Execute ONE story only (cautious mode, checkpoint-friendly)

**Flow:**
Same as one iteration of ralph-run, but explicitly stops after one story.
Good for:
- Testing the workflow
- Reviewing after each story
- When you want manual control

Output: "Story done. Run `/ralph-next` again or `/ralph-run` for autonomous mode."

---

### 4. `/ralph-status`

**Purpose:** Check progress without executing

**Output:**
```
Ralph: auth-feature
Branch: ralph/auth-feature
Progress: 7/12 stories (58%)

Last: AUTH-007 "Add password validation" - COMPLETED
Next: AUTH-008 "Add password reset flow"

Blocked: AUTH-011 (waiting on AUTH-010)
```

---

### 5. `/ralph-done`

**Purpose:** Complete feature, archive, create PR

**Flow:**
1. Check all stories completed
   - If incomplete → "3 stories remaining. Complete them or run `/ralph-abandon`"
2. Run final review on all changes vs main
3. Generate `summary.md`:
   - Feature name, branch, dates
   - Stories completed
   - Key patterns learned
   - Files changed
4. Move `.ralph/<feature>/` to `.ralph-archive/<feature>/`
5. Commit: `"ralph: archive <feature-name>"`
6. Create PR to main
7. Output: PR link

---

### 6. `/ralph-abandon`

**Purpose:** Give up on feature, clean up

**Flow:**
1. Confirm: "Abandon <feature>? This deletes all tracking. (y/n)"
2. Delete `.ralph/<feature>/` directory
3. Optionally delete branch or leave it
4. Output: "Abandoned. Branch `ralph/<feature>` still exists if you want the code."

---

## Security Note

Ralph runs with `--dangerously-skip-permissions` for autonomous operation. This means:
- ✅ No manual approval needed for file reads/writes
- ✅ No manual approval for bash commands
- ⚠️ Full access to your codebase
- ⚠️ Can run any command without asking

**Only use Ralph on:**
- Trusted codebases
- Projects with good test coverage
- Features you're comfortable automating

**You can cancel anytime** with Ctrl+C in the terminal running ralph.sh

---

## Agents

### `ralph-planner`

**Purpose:** Gather requirements, create plan and stories

**Process:**
1. If `--from <file>` provided: read spec from file
2. Otherwise ask user questions:
   - What problem does this solve?
   - What are the main components/screens?
   - Any technical constraints or dependencies?
   - What does "done" look like?
3. Generate `plan.md`:
   - Summary, features, file structure, verification
4. Generate `prd.json`:
   - Break into 8-15 stories
   - Each story: 15-45 min of focused work (guideline, not hard limit)
   - Clear steps and passes criteria
   - Set dependencies and priorities

**Dependency identification guidance:**
Mark story B depends on story A if:
- B modifies files that A creates
- B uses types/functions that A defines
- B tests functionality that A builds
- B can't run without A being done first

Example: If AUTH-002 "Add password validation" modifies the form created in AUTH-001 "Add login form", then AUTH-002 depends on AUTH-001.

**Pattern promotion guidance:**
Add to progress.txt "Codebase Patterns" section patterns that apply beyond this feature:
- ✅ Project conventions (e.g., "Always use IF NOT EXISTS in migrations")
- ✅ Test patterns (e.g., "Run dev server before E2E tests")
- ✅ Gotchas that affect multiple areas
- ❌ Feature-specific implementation details

If a pattern is truly project-wide and permanent, also update the project's `CLAUDE.md`

---

### `ralph-executor`

**Purpose:** Execute a single story

**Process:**
1. Read story details from prd.json
2. Implement following steps array
3. Run typecheck/tests
4. Verify passes criteria
5. Return result for review/commit

---

## Skill

### `ralph` (SKILL.md)

**Triggers:** "ralph", "feature loop", "autonomous development", "story workflow"

**Content:** Explains Ralph workflow, commands, file structure, when to use.

---

## Hooks

### `hooks.json`

```json
{
  "SessionStart": [{
    "hooks": [{
      "type": "prompt",
      "prompt": "Check if .ralph/ directory exists with a feature folder. If yes, read the last 10 lines of .ralph/<feature>/progress.txt and remind: 'Ralph feature active: <name>. Last activity: <from progress>. Read .ralph/<feature>/claude.md for workflow. Run /ralph-status or /ralph-continue.'"
    }]
  }]
}
```

---

## Templates

### `progress.txt`

```
# Ralph Progress: {{FEATURE_NAME}}
Branch: ralph/{{FEATURE_NAME}}
Started: {{DATE}}

## Codebase Patterns
<!-- Add reusable patterns here as you discover them -->
<!-- These persist across stories and compound learnings -->

---

## Log

=== {{DATE}} - Initialized ===
Feature: {{FEATURE_NAME}}
Stories: {{STORY_COUNT}}
Ready to start.

---
```

### `prd.json`

```json
{
  "feature": "{{FEATURE_NAME}}",
  "branch": "ralph/{{FEATURE_NAME}}",
  "created": "{{DATE}}",
  "stories": []
}
```

### Story Schema

```json
{
  "id": "FEAT-001",
  "title": "Short description",
  "steps": ["Step 1", "Step 2"],
  "passes": ["Criteria 1", "Criteria 2", "typecheck passes", "tests pass"],
  "dependencies": [],
  "priority": 1,
  "status": "not_started|in_progress|completed|blocked",
  "blockers": []
}
```

### `plan.md`

```markdown
# {{FEATURE_NAME}}

## Summary
{{DESCRIPTION}}

## Features
- Feature 1
- Feature 2

## File Structure
### New Files
### Modified Files

## Verification
- [ ] All stories complete
- [ ] Typecheck passes
- [ ] Tests pass
- [ ] Manual verification done
```

### `claude.md`

The workflow instructions (adapted from existing workspace-manager claude.md):
- Context restoration steps
- Story picking logic (check dependencies, priority)
- Development cycle (implement → verify → review)
- Review loop with parallel agents
- Commit conventions
- Progress update format (with STARTED/COMPLETED timestamps)
- Crash recovery handling
- Completion signals (RALPH_COMPLETE, RALPH_BLOCKED)
- Pattern learning and CLAUDE.md updates

**Critical: End of Iteration Behavior**

After committing tracking updates, the template MUST instruct:

```markdown
## End of Iteration

After committing all updates:

1. Check completion status:
   - If ALL stories in prd.json have `status: "completed"` → Output `RALPH_COMPLETE` and exit
   - If blocked (missing info, external dependency, unclear requirement) → Output `RALPH_BLOCKED: <reason>` and exit
   - Otherwise → Output summary and exit immediately

2. **DO NOT:**
   - ❌ Suggest commands like /ralph-continue or /ralph-run
   - ❌ Wait for user input
   - ❌ Ask what to do next
   - ❌ Stay in interactive mode

3. **DO:**
   - ✅ Output a brief summary
   - ✅ Exit immediately (bash loop will continue)

Example outputs:

Normal completion:
```
✅ Story SKETCH-001 complete.
Progress: 1/15 stories
Next: SKETCH-002
```

All done:
```
RALPH_COMPLETE
All 15 stories completed successfully.
```

Blocked:
```
RALPH_BLOCKED: Need API endpoint URL for external service integration
Cannot proceed with SKETCH-007 without this information.
```
```

This ensures Claude exits cleanly so the bash loop can start the next iteration with fresh context.

### `ralph.sh`

The bash loop script (generated by /ralph-run, placed in .ralph/):

```bash
#!/bin/bash
# Generated by Ralph plugin

MAX_ITERATIONS=${1:-20}
SCRIPT_DIR="$(dirname "$0")"

for i in $(seq 1 $MAX_ITERATIONS); do
  echo "=== Ralph iteration $i/$MAX_ITERATIONS ==="

  OUTPUT=$(claude --dangerously-skip-permissions \
    -p "$(cat "$SCRIPT_DIR"/claude.md)" 2>&1)

  if echo "$OUTPUT" | grep -q "RALPH_COMPLETE"; then
    echo "✅ All stories complete!"
    exit 0
  fi

  if echo "$OUTPUT" | grep -q "RALPH_BLOCKED"; then
    echo "⚠️ Blocked - needs human input"
    exit 1
  fi

  sleep 2
done

echo "⚠️ Max iterations reached"
exit 1
```

---

## Progress Entry Format

```
=== {{DATE}} {{TIME}} ===
STARTED: {{STORY_ID}} at {{TIMESTAMP}}
Story: {{STORY_ID}}
Title: {{TITLE}}
Action: What was implemented
Result: COMPLETED | BLOCKED
COMPLETED: {{STORY_ID}} at {{TIMESTAMP}}
Commit: {{HASH}}
Files: file1.ts, file2.ts
Learnings:
  - Pattern discovered
  - Gotcha encountered
Next: {{NEXT_STORY_ID}}
```

---

## Build Order

1. **Templates first** - claude.md, prd.json, progress.txt, plan.md, ralph.sh
2. **`/ralph-next`** - One story execution (core engine)
3. **`/ralph-run`** - Bash loop wrapper + script generation
4. **`/ralph-status`** - Simple read-only status
5. **`/ralph-new`** - Setup + planner agent (with --from flag)
6. **`/ralph-done`** - Archive + PR
7. **`/ralph-abandon`** - Cleanup
8. **Hooks** - SessionStart reminder
9. **Skill** - Documentation

---

## Verification

1. **Manual test:** Create a small feature with 3 stories, run through full cycle
2. **Crash recovery:** Kill mid-story, verify `/ralph-continue` resumes correctly
3. **Completion detection:** Verify it detects all stories done
4. **Archive flow:** Verify `/ralph-done` creates proper archive and PR

---

## Files to Create

```
plugins/ralph/
├── .claude-plugin/plugin.json
├── commands/ralph-new.md
├── commands/ralph-run.md
├── commands/ralph-next.md
├── commands/ralph-status.md
├── commands/ralph-done.md
├── commands/ralph-abandon.md
├── agents/ralph-planner.md
├── agents/ralph-executor.md
├── skills/ralph/SKILL.md
├── hooks/hooks.json
├── templates/claude.md
├── templates/prd.json
├── templates/plan.md
├── templates/progress.txt
└── templates/ralph.sh
```

Total: 16 files
